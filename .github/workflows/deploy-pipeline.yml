name: Build and Deploy FastAPI to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  ACR_NAME: nerfastapiacr
  IMAGE_NAME: fastapi-app
  RESOURCE_GROUP: ner-service-rg
  LOCATION: eastus

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and Push to ACR
        run: |
          echo "Building image: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile .

      - name: Build Summary
        run: |
          echo "âœ… Image built successfully!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, qa, prod]
    
    environment:
      name: ${{ matrix.environment }}
      url: ${{ steps.deploy.outputs.app-url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log principals and ACR info (troubleshooting)
        run: |
          set -euo pipefail
          APP_NAME=fastapi-${{ matrix.environment }}
          RG=${{ env.RESOURCE_GROUP }}
          ACR_NAME=${{ env.ACR_NAME }}

          echo "--- Signed-in account ---"
          az account show --query "{name:user.name, type:user.type, subscription:id}" -o json || echo "(unable to show account)"

          echo "--- ACR info ---"
          az acr show -n $ACR_NAME --query "{name:name, loginServer:loginServer, id:id}" -o json || echo "(unable to show acr)"

          echo "--- Container App principal ---"
          PRINCIPAL_ID=$(az containerapp show -n $APP_NAME -g $RG --query identity.principalId -o tsv || echo "")
          echo "APP_NAME=$APP_NAME"
          echo "PRINCIPAL_ID=${PRINCIPAL_ID:-<none>}"

          if [ -n "$PRINCIPAL_ID" ]; then
            echo "--- Role assignments for principal on ACR ---"
            ACR_ID=$(az acr show -n $ACR_NAME --query id -o tsv || echo "")
            if [ -n "$ACR_ID" ]; then
              az role assignment list --assignee-object-id "$PRINCIPAL_ID" --scope "$ACR_ID" -o json || echo "(no role assignments or cannot query)"
              echo "--- All AcrPull assignments on ACR ---"
              az role assignment list --role AcrPull --scope "$ACR_ID" -o json || echo "(cannot list acrpull assignments)"
            else
              echo "(unable to resolve ACR_ID)"
            fi
          else
            echo "(container app has no principal id)"
          fi

      - name: Ensure Container App can pull from ACR (require managed identity AcrPull)
        run: |
          set -euo pipefail
          APP_NAME=fastapi-${{ matrix.environment }}
          RG=${{ env.RESOURCE_GROUP }}
          ACR_NAME=${{ env.ACR_NAME }}

          # Enable system-assigned identity if missing
          PRINCIPAL_ID=$(az containerapp show -n $APP_NAME -g $RG --query identity.principalId -o tsv || echo "")
          if [ -z "$PRINCIPAL_ID" ] || [ "$PRINCIPAL_ID" = "null" ]; then
            echo "Enabling system-assigned identity for $APP_NAME"
            az containerapp update -n $APP_NAME -g $RG --set identity.type=SystemAssigned
            PRINCIPAL_ID=$(az containerapp show -n $APP_NAME -g $RG --query identity.principalId -o tsv)
          fi

          if [ -z "$PRINCIPAL_ID" ] || [ "$PRINCIPAL_ID" = "null" ]; then
            echo "ERROR: failed to obtain container app principalId" >&2
            exit 1
          fi

          # Get ACR resource id
          ACR_ID=$(az acr show -n $ACR_NAME --query id -o tsv || echo "")
          if [ -z "$ACR_ID" ]; then
            echo "ERROR: failed to resolve ACR id for $ACR_NAME" >&2
            exit 1
          fi

          # Assign AcrPull explicitly using object id to avoid Graph queries
          echo "Assigning AcrPull to principal $PRINCIPAL_ID on $ACR_ID"
          az role assignment create --assignee-object-id "$PRINCIPAL_ID" --assignee-principal-type ServicePrincipal --role AcrPull --scope "$ACR_ID" || true

          # Wait for role assignment to propagate (timeout ~180s)
          echo "Waiting for AcrPull assignment to appear (timeout 180s)"
          attempt=0
          until az role assignment list --assignee-object-id "$PRINCIPAL_ID" --role AcrPull --scope "$ACR_ID" -o tsv | grep -q .; do
            attempt=$((attempt+1))
            if [ $attempt -ge 36 ]; then
              echo "ERROR: AcrPull role assignment did not appear within timeout. Ensure the workflow's SP can create role assignments or assign AcrPull manually." >&2
              exit 1
            fi
            sleep 5
          done

          echo "AcrPull role assignment confirmed. Proceeding with deployment using managed identity."

      - name: Configure Container App registry to use managed identity
        run: |
          set -euo pipefail
          APP_NAME=fastapi-${{ matrix.environment }}
          az containerapp registry set \
            --name $APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --server ${{ env.ACR_NAME }}.azurecr.io \
            --identity system

      - name: Load Environment Variables
        id: load-env
        run: |
          # Load environment-specific variables from infra/*.env
          if [ -f "infra/${{ matrix.environment }}.env" ]; then
            echo "Loading variables from infra/${{ matrix.environment }}.env"
            cat infra/${{ matrix.environment }}.env
          fi

      - name: Deploy to Container App
        id: deploy
        env:
          APP_NAME: fastapi-${{ matrix.environment }}
          IMAGE_FULL: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          echo "Deploying $IMAGE_FULL to $APP_NAME..."

          # Retry deploy on transient ACR auth errors (UNAUTHORIZED) - up to 5 attempts
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Deploy attempt $attempt/$max_attempts"
            OUTPUT=$(az containerapp update \
              --name $APP_NAME \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image $IMAGE_FULL \
              --set-env-vars \
                APP_ENV=${{ matrix.environment }} \
                DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
                GIT_SHA=${{ github.sha }} 2>&1) || true

            if echo "$OUTPUT" | grep -qi "provision revision" && echo "$OUTPUT" | grep -qi "error details"; then
              # az returned an error; check for auth-related messages
              echo "Deploy failed on attempt $attempt:"
              echo "$OUTPUT" | sed -n '1,200p'

              if echo "$OUTPUT" | grep -qiE "unauthorized|authentication required|401|access denied|cannot pull"; then
                echo "Detected authentication/authorization error; will retry after backoff."
                sleep_time=$((attempt * 6))
                echo "Sleeping $sleep_time seconds before retry..."
                sleep $sleep_time
                attempt=$((attempt+1))
                continue
              else
                echo "Non-auth error during deploy; failing immediately." >&2
                exit 1
              fi
            else
              # Assume success if no error text matched
              echo "Deploy command completed; checking app status..."
              break
            fi
          done

          if [ $attempt -gt $max_attempts ]; then
            echo "ERROR: Deployment failed after $max_attempts attempts" >&2
            exit 1
          fi
          
          # Get the app URL
          APP_URL=$(az containerapp show \
            --name $APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "app-url=https://$APP_URL" >> $GITHUB_OUTPUT
          
          echo "### ðŸš€ Deployed to ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App**: $APP_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://$APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: $IMAGE_FULL" >> $GITHUB_STEP_SUMMARY

      - name: Health Check
        run: |
          APP_URL="${{ steps.deploy.outputs.app-url }}"
          echo "Running health check on $APP_URL/health"
          
          # Wait for app to be ready
          sleep 10
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL/health || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health check passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Health check returned: $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
          fi