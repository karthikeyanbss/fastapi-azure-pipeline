name: Build and Deploy FastAPI to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  ACR_NAME: nerfastapiacr
  IMAGE_NAME: fastapi-app
  RESOURCE_GROUP: ner-service-rg
  LOCATION: eastus
  CONTAINERAPPS_ENV: ner-fastapi-env

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and Push to ACR
        run: |
          echo "Building image: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile .

      - name: Build Summary
        run: |
          echo "âœ… Image built successfully!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, qa, prod]
    
    environment:
      name: ${{ matrix.environment }}
      url: ${{ steps.deploy.outputs.app-url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Load Environment Variables
        id: load-env
        run: |
          # Load environment-specific variables from infra/*.env
          if [ -f "infra/${{ matrix.environment }}.env" ]; then
            echo "Loading variables from infra/${{ matrix.environment }}.env"
            cat infra/${{ matrix.environment }}.env
          fi

      - name: Deploy or create Container App
        id: deploy
        env:
          APP_NAME: fastapi-${{ matrix.environment }}
          IMAGE_FULL: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ENV_NAME: ${{ env.CONTAINERAPPS_ENV }}
        run: |
          set -euo pipefail
          echo "=== Deploying $IMAGE_FULL to $APP_NAME ==="

          RG=${{ env.RESOURCE_GROUP }}
          ACR_SERVER=${{ env.ACR_NAME }}.azurecr.io
          ACR_NAME=${{ env.ACR_NAME }}
          PORT=8000

          # Get ACR resource ID first
          echo "Getting ACR resource ID"
          ACR_ID=$(az acr show -n $ACR_NAME -g $RG --query id -o tsv)
          echo "ACR ID: $ACR_ID"

          # Check if app exists
          APP_EXISTS=false
          if az containerapp show -n $APP_NAME -g $RG >/dev/null 2>&1; then
            APP_EXISTS=true
            echo "Container App exists"
          else
            echo "Container App does not exist - will create new"
          fi

          if [ "$APP_EXISTS" = "true" ]; then
            # Get existing principal ID
            PRINCIPAL_ID=$(az containerapp show -n $APP_NAME -g $RG --query identity.principalId -o tsv)
            echo "Existing principal ID: $PRINCIPAL_ID"
            
            # Ensure role assignment exists
            if [ -n "$PRINCIPAL_ID" ] && [ "$PRINCIPAL_ID" != "null" ]; then
              echo "Ensuring AcrPull role assignment"
              az role assignment create \
                --assignee-object-id "$PRINCIPAL_ID" \
                --assignee-principal-type ServicePrincipal \
                --role AcrPull \
                --scope "$ACR_ID" || true
            fi

            # Update the app
            echo "Updating existing Container App"
            az containerapp update \
              --name $APP_NAME \
              --resource-group $RG \
              --image $IMAGE_FULL \
              --set-env-vars \
                APP_ENV=${{ matrix.environment }} \
                DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
                GIT_SHA=${{ github.sha }}
          else
            # Create new app with identity
            echo "Creating new Container App"
            az containerapp create \
              --name $APP_NAME \
              --resource-group $RG \
              --environment $ENV_NAME \
              --image $IMAGE_FULL \
              --target-port $PORT \
              --ingress external \
              --registry-server $ACR_SERVER \
              --registry-identity system \
              --system-assigned \
              --min-replicas 1 \
              --max-replicas 3 \
              --env-vars \
                APP_ENV=${{ matrix.environment }} \
                DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
                GIT_SHA=${{ github.sha }}

            # Get the new principal ID
            echo "Getting principal ID from newly created app"
            sleep 10
            PRINCIPAL_ID=$(az containerapp show -n $APP_NAME -g $RG --query identity.principalId -o tsv)
            echo "New principal ID: $PRINCIPAL_ID"

            # Assign AcrPull role
            if [ -n "$PRINCIPAL_ID" ] && [ "$PRINCIPAL_ID" != "null" ]; then
              echo "Assigning AcrPull role to managed identity"
              az role assignment create \
                --assignee-object-id "$PRINCIPAL_ID" \
                --assignee-principal-type ServicePrincipal \
                --role AcrPull \
                --scope "$ACR_ID"
              echo "Waiting for role assignment to propagate"
              sleep 20
            else
              echo "ERROR: Failed to get principal ID"
              exit 1
            fi
          fi
          
          # Get the app URL
          APP_URL=$(az containerapp show \
            --name $APP_NAME \
            --resource-group $RG \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "app-url=https://$APP_URL" >> $GITHUB_OUTPUT
          
          echo "### ðŸš€ Deployed to ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App**: $APP_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://$APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: $IMAGE_FULL" >> $GITHUB_STEP_SUMMARY
          echo "- **Principal ID**: $PRINCIPAL_ID" >> $GITHUB_STEP_SUMMARY

      - name: Health Check
        run: |
          APP_URL="${{ steps.deploy.outputs.app-url }}"
          echo "Running health check on $APP_URL/health"
          
          # Wait for app to be ready
          sleep 10
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL/health || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health check passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Health check returned: $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
          fi