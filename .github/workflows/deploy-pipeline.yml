name: Build and Deploy FastAPI to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  ACR_NAME: nerfastapiacr
  IMAGE_NAME: fastapi-app
  RESOURCE_GROUP: ner-service-rg
  LOCATION: eastus

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and Push to ACR
        run: |
          echo "Building image: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          az acr build \
            --registry ${{ env.ACR_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile .

      - name: Build Summary
        run: |
          echo "âœ… Image built successfully!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, qa, prod]
    
    environment:
      name: ${{ matrix.environment }}
      url: ${{ steps.deploy.outputs.app-url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Container App can pull from ACR (try managed identity, fallback to secrets)
        run: |
          set -euo pipefail
          APP_NAME=fastapi-${{ matrix.environment }}
          RG=${{ env.RESOURCE_GROUP }}
          ACR_NAME=${{ env.ACR_NAME }}

          # Try to enable system-assigned identity if missing
          PRINCIPAL_ID=$(az containerapp show -n $APP_NAME -g $RG --query identity.principalId -o tsv || echo "")
          if [ -z "$PRINCIPAL_ID" ] || [ "$PRINCIPAL_ID" = "null" ]; then
            echo "Enabling system-assigned identity for $APP_NAME"
            az containerapp update -n $APP_NAME -g $RG --set identity.type=SystemAssigned || true
            PRINCIPAL_ID=$(az containerapp show -n $APP_NAME -g $RG --query identity.principalId -o tsv || echo "")
          fi

          ACR_ID=$(az acr show -n $ACR_NAME --query id -o tsv || echo "")

          if [ -n "$PRINCIPAL_ID" ] && [ -n "$ACR_ID" ]; then
            echo "Attempting to assign AcrPull to principal $PRINCIPAL_ID on $ACR_ID"
            if az role assignment create --assignee "$PRINCIPAL_ID" --role "AcrPull" --scope "$ACR_ID"; then
              echo "AcrPull role assigned successfully. Using managed identity to pull images."
            else
              echo "Warning: role assignment failed or insufficient permissions. Falling back to registry credentials." >&2
              # Fallback to setting registry credentials using secrets
              if [ -z "${{ secrets.ACR_USERNAME }}" ] || [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
                echo "ERROR: ACR credentials not found in secrets (ACR_USERNAME/ACR_PASSWORD). Cannot configure fallback." >&2
                exit 1
              fi
              echo "Configuring registry credentials on $APP_NAME using provided secrets"
              az containerapp update --name $APP_NAME --resource-group $RG --set configuration.registries="[{\"server\":\"${ACR_NAME}.azurecr.io\",\"username\":\"${{ secrets.ACR_USERNAME }}\",\"password\":\"${{ secrets.ACR_PASSWORD }}\"}]"
            fi
          else
            echo "Principal ID or ACR ID missing; attempting to configure registry credentials fallback"
            if [ -z "${{ secrets.ACR_USERNAME }}" ] || [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
              echo "ERROR: ACR credentials not found in secrets (ACR_USERNAME/ACR_PASSWORD). Cannot configure fallback." >&2
              exit 1
            fi
            az containerapp update --name $APP_NAME --resource-group $RG --set configuration.registries="[{\"server\":\"${ACR_NAME}.azurecr.io\",\"username\":\"${{ secrets.ACR_USERNAME }}\",\"password\":\"${{ secrets.ACR_PASSWORD }}\"}]"
          fi

      - name: Load Environment Variables
        id: load-env
        run: |
          # Load environment-specific variables from infra/*.env
          if [ -f "infra/${{ matrix.environment }}.env" ]; then
            echo "Loading variables from infra/${{ matrix.environment }}.env"
            cat infra/${{ matrix.environment }}.env
          fi

      - name: Deploy to Container App
        id: deploy
        env:
          APP_NAME: fastapi-${{ matrix.environment }}
          IMAGE_FULL: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          echo "Deploying $IMAGE_FULL to $APP_NAME..."
          
          az containerapp update \
            --name $APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image $IMAGE_FULL \
            --set-env-vars \
              APP_ENV=${{ matrix.environment }} \
              DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
              GIT_SHA=${{ github.sha }}
          
          # Get the app URL
          APP_URL=$(az containerapp show \
            --name $APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "app-url=https://$APP_URL" >> $GITHUB_OUTPUT
          
          echo "### ðŸš€ Deployed to ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App**: $APP_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://$APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: $IMAGE_FULL" >> $GITHUB_STEP_SUMMARY

      - name: Health Check
        run: |
          APP_URL="${{ steps.deploy.outputs.app-url }}"
          echo "Running health check on $APP_URL/health"
          
          # Wait for app to be ready
          sleep 10
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL/health || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health check passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Health check returned: $HTTP_STATUS" >> $GITHUB_STEP_SUMMARY
          fi